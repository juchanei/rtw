# 7 : 다형성을 가진 기본 클래스에서는 소멸자를 반드시 가상 소멸자로 선언하자

## 문제인식

C++에서는, 파생 클래스가 소멸 될 때 **기본 클래스의 소멸자가 가상함수가 아닌 경우, 프로그램의 동작이 미정의사항** 입니다.
아래 코드를 보세요.

```c++
class Base {
public:
  ~Base() { /* ... */}
}

class Derived :public Base {
public:
  ~Derived() {/* ... 이부분의 코드는 실행되지 않습니다 ... */}
}
```

C++에서는, 파생클래스의 소멸자가 호출 될 경우, 상속계층을 타고올라가 기본 클래스의 소멸자를 순차적으로 호출하도록 되어있습니다.
이런 방식으로 기본 클래스의 멤버가 사용한 자원들을 적절히 해제한 후, 자원 해제의 순서가 파생 클래스의 소멸자로 넘어옵니다.
이때 만일 기본 클래스의 소멸자가 비가상함수라면 동적바인딩 되지 않으므로, 기본 클래스로 올라갔던 자원 해제 순서가 파생 클래스까지 내려오지 않게 됩니다.
이는 **부분 소멸 (partial destroyed)** 을 일으키며 자원을 유출시키는 중대한 오류를 일으킵니다.

## 문제해결

### 기본 클래스의 가상 소멸자

결론은, **상속될 가능성이 있는 클래스는 반드시 가상소멸자를 가져야** 합니다.
비가상소멸자를 가진 클래스는 기본 클래스로 사용될 의지를 상실했다고 봐도 무방합니다.

```c++
// 올바른 코드
class Base {
public:
  virtual ~Base() { /* ... */}
}

class Derived :public Base {
public:
  ~Derived() {/* ...  */}
```

종종, 어떤 라이브러리의 클래스를 상속해서 기능을 추가하는 등의 행동을 하고 싶은 경우가 있습니다.
이러한 행동이 의미있는 행동이 되려면, 해당 클래스에 반드시 가상소멸자가 존재하는지 확인한 후에 해야합니다.
STL의 string 클래스 따위를 상속해서 기능을 확장하려는 생각은 접는게 좋습니다.
STL의 대부분의 클래스는 비가상소멸자를 갖고 있기 때문입니다.

### 가상 소멸자의 문제점

클래스의 소멸자를 모두 가상함수로 선언하는 것은, 기본 클래스의 소멸자를 비가상함수로 선언하는 것과 같은 수준으로 좋지 않습니다.
클래스에 단 하나의 가상함수만 존재하더라도, 클래스에 보이지않는 별도의 자료구조가 추가됩니다.

가상함수가 존재한다는 것은 **동적 바인딩** 을 하겠다는 말과 동일합니다.
동적 바인딩은 런타임에 실행할 함수를 결정하는 것으로, 프로그램은 실행 가능한 여러개의 함수 중 하나를 선택하여 실행하도록 해야만 합니다.

```c++
class Base{
public:
  virtual ~Base() {/* ... */}
}

class DerivedA{
public:
  ~DerivedA() {/* ... */};
}

class DerivedB{
public:
  ~DerivedB() {/* ... */};
}

int main(){
  Base* ptr = new DerivedA();
  delete ptr;   //어떤 소멸자를 호출할지 런타임에 결정한다!
}
```

따라서 가상함수를 가진 클래스는 실행 가능 한 함수들이 무엇인지 미리 알고 있어야 하며, 이는 **가상함수테이블** (vtbl이라는 배열)이라는 자료구조로 존재합니다.
클래스에 가상함수를 추가하는 경우, 내부에 가상함수테이블을 가리키는 **가상함수테이블포인터**(vptr이라는 포인터)가 생깁니다.
이는 클래스의 크기를 증가시키는데, 프로그램 실행환경이 32비트인지 64비트인지에 따라 그 정도가 달라집니다.
문제는 크기가 증가했다는 사실이 아니라 C++에만 존재하는 자료구조가 클래스의 멤버로 추가 되었다는 것인데, 이 때문에 다른 언어로 해당 클래스의 객체를 **이식하려는 기대를 접어야** 만 합니다.
이러한 문제를 원하지 않는다면, **가상 소멸자는 해당 클래스에 가상함수가 하나 이상 존재할 때만** 선언하는 것으로 한정하세요.

## 정리

- 파생 될 기본 클래스는 반드시 가상소멸자를 가져야 합니다.
- 파생되지 않을 클래스는 가상소멸자를 만들지 마세요.
